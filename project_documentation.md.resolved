# Playshire Local Bridge - System Documentation

This document provides a technical overview of the "Local Bridge" system, which synchronizes sports facility bookings between a local dashboard, a database, and external portals (Playo & Hudle).

---

## 1. System Architecture

The system follows a **Modular Architecture** with specific design patterns:
- **Coordinator Pattern**: [BrowserSync](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py#24-185) acts as a central coordinator managing scraping tasks.
- **Strategy Pattern**: Scraping logic is encapsulated in specific strategy classes ([PlayoScraper](file:///c:/kshitiz/D/CentralManagementPython/scrapers/playo_scraper.py#10-303), [HudleScraper](file:///c:/kshitiz/D/CentralManagementPython/scrapers/hudle_scraper.py#11-182)) adhering to a common interface ([BaseScraper](file:///c:/kshitiz/D/CentralManagementPython/scrapers/base_scraper.py#5-20)).
- **ACID Compliant Database**: Uses SQLite with Write-Ahead Logging (WAL) and strict transaction management via Context Managers.
- **Client-Server**: A FastAPI backend serves a Dashboard frontend ([dashboard.html](file:///c:/kshitiz/D/CentralManagementPython/dashboard.html)) and exposes REST APIs.

---

## 2. File Structure & Major Components

### [main.py](file:///c:/kshitiz/D/CentralManagementPython/main.py) (Entry Point & API)
The core FastAPI application.
- **Role**: Initializes the system, serves the dashboard, and handles API requests.
- **Key Functions**:
  - [lifespan(app)](file:///c:/kshitiz/D/CentralManagementPython/main.py#48-68): Async context manager handling startup (DB init, Browser connection) and shutdown.
  - [get_dashboard_data(date, force, source)](file:///c:/kshitiz/D/CentralManagementPython/main.py#104-142): **GET** endpoint. Fetches bookings from the DB. accepting `source` (`all`, [playo](file:///c:/kshitiz/D/CentralManagementPython/scrapers/playo_scraper.py#269-277), [hudle](file:///c:/kshitiz/D/CentralManagementPython/scrapers/hudle_scraper.py#61-98)) to filter data. Triggers on-demand scraping if `force=True`.
  - [receive_booking(booking)](file:///c:/kshitiz/D/CentralManagementPython/main.py#80-103): **POST** endpoint. Handles booking requests (e.g., from WhatsApp or Dashboard), checks availability, and triggers automation.

### [browser_sync.py](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py) (Coordinator)
The central logic Hub.
- **Role**: Manages the scraping queue, cooldowns, and delegates work to specific scrapers.
- **Key Class**: [BrowserSync](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py#24-185)
  - [__init__](file:///c:/kshitiz/D/CentralManagementPython/scrapers/playo_scraper.py#11-21): Initializes the [PlayoScraper](file:///c:/kshitiz/D/CentralManagementPython/scrapers/playo_scraper.py#10-303) and [HudleScraper](file:///c:/kshitiz/D/CentralManagementPython/scrapers/hudle_scraper.py#11-182) strategies.
  - [sync_availability()](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py#66-114): An infinite loop that periodically checks the `scrape_queue` or waits for defaults (Today/Tomorrow). Dispatches the page tab to the relevant scraper.
  - [request_date(date, force)](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py#40-65): Adds a date to the priority queue for immediate scraping.
  - [_get_dates_to_scrape_and_cleanup_queue()](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py#115-174): Logic to merge high-priority queue items with functionality defaults, respecting cooldowns (10 mins).

### [database.py](file:///c:/kshitiz/D/CentralManagementPython/database.py) (Data Persistence)
Handles all database interactions with ACID guarantees.
- **Role**: Storage and Retrieval of booking slots.
- **Key Components**:
  - [get_db_connection()](file:///c:/kshitiz/D/CentralManagementPython/database.py#30-49): **Context Manager**. Yields a connection, automatically commits on success, and rolls back on exception. Ensures atomicity.
  - [init_db()](file:///c:/kshitiz/D/CentralManagementPython/database.py#50-103): Sets up the SQLite database, enables **WAL Mode** (Write-Ahead Logging) for concurrency, and creates tables.
  - [save_booked_slots_playo(slots)](file:///c:/kshitiz/D/CentralManagementPython/database.py#166-168) / [save_booked_slots_hudle(slots)](file:///c:/kshitiz/D/CentralManagementPython/database.py#163-165): Helper functions for bulk-saving data to respective tables using transactions.

### [connection_manager.py](file:///c:/kshitiz/D/CentralManagementPython/connection_manager.py) (Browser Control)
Manages the connection to the Chrome browser.
- **Role**: Connects to an existing Chrome instance on port 9222.
- **Key Functions**:
  - [initialize()](file:///c:/kshitiz/D/CentralManagementPython/connection_manager.py#149-162): Connects to Chrome using `playwright`, finds or opens the required tabs (Hudle Partner, Playo Partner).
  - `ensure_tabs()`: Verifies that the required tabs are still open.

### `scrapers/` (Scraping Logic)
Contains the specific logic for each platform.
- **[base_scraper.py](file:///c:/kshitiz/D/CentralManagementPython/scrapers/base_scraper.py)**: Abstract Base Class defining the contract ([scrape(page, requests)](file:///c:/kshitiz/D/CentralManagementPython/scrapers/base_scraper.py#11-20)).
- **[playo_scraper.py](file:///c:/kshitiz/D/CentralManagementPython/scrapers/playo_scraper.py)**:
  - **Logic**: DOM manipulation. uses `page.evaluate()` to inject JavaScript that detects tables/grids in the Playo UI, extracts times/courts, and identifies status (Booked/Available/Locked).
  - **Navigation**: robustly handles Playo's date picker interactions.
- **[hudle_scraper.py](file:///c:/kshitiz/D/CentralManagementPython/scrapers/hudle_scraper.py)**:
  - **Logic**: API Hijacking/Use. Instead of scraping the DOM, it re-uses the browser's authentication token (from LocalStorage) to make direct HTTP calls to Hudle's internal API (`api.hudle.in`).
  - **Mapping**: Maps Hudle's generated "Group Names" (e.g., "Pool Table 1") to the standardized names used in the system.

### [dashboard.html](file:///c:/kshitiz/D/CentralManagementPython/dashboard.html) (Frontend)
A single-page interface for viewing and managing slots.
- **Features**:
  - **Grid View**: Visualizes slots by Time vs Sport/Court.
  - **Filters**: Date Picker, Sport Filter, and **Source Filter** (Playo/Hudle/All).
  - **Logic**: Fetches JSON from `/dashboard-data` and renders it using JavaScript. Handles logic to merge or separate sources based on user selection.

---

## 3. Database Schema

The system uses [bookings.db](file:///c:/kshitiz/D/CentralManagementPython/bookings.db) (SQLite). For debugging and data integrity, data is split into source-specific tables.

### Tables: `bookings_hudle`, `bookings_playo`, [bookings](file:///c:/kshitiz/D/CentralManagementPython/database.py#119-140) (Legacy/Manual)
All tables share the same schema:

| Column | Type | Description |
| :--- | :--- | :--- |
| [id](file:///c:/kshitiz/D/CentralManagementPython/dashboard.html#186-306) | INTEGER PK | Auto-increment unique ID |
| [date](file:///c:/kshitiz/D/CentralManagementPython/browser_sync.py#40-65) | TEXT | YYYY-MM-DD format |
| `time` | TEXT | HH:MM format (24h) |
| `source` | TEXT | 'Playo', 'Hudle', 'Manual', etc. |
| [sport](file:///c:/kshitiz/D/CentralManagementPython/scrapers/playo_scraper.py#114-120) | TEXT | Standardized Sport Name (e.g., 'Badminton Premium Hybrid') |
| `court` | TEXT | Standardized Court Name (e.g., 'Court 1') |
| [status](file:///c:/kshitiz/D/CentralManagementPython/connection_manager.py#84-132) | TEXT | 'Booked', 'Available', 'Locked' |
| `customer_name` | TEXT | Optional customer details |
| `customer_phone` | TEXT | Optional |

**Constraints**:
- `UNIQUE(date, time, sport, court)`: Prevents duplicate entries for the same slot. Upsert logic (`INSERT OR REPLACE`) is used during scraping.

---

## 4. API Logic Flow

### Dashboard Data Flow
1. **User** opens Dashboard -> [loadData()](file:///c:/kshitiz/D/CentralManagementPython/dashboard.html#142-180) called in JS.
2. **Frontend** calls `GET /dashboard-data?date=...&source=...`.
3. **Backend ([main.py](file:///c:/kshitiz/D/CentralManagementPython/main.py))**:
   - Calls `database.get_bookings(date, table_name)` for each requested source.
   - If `source='playo'`, reads `bookings_playo`.
   - If `source='all'`, reads and combines `bookings_playo`, `bookings_hudle`, and [bookings](file:///c:/kshitiz/D/CentralManagementPython/database.py#119-140).
4. **Scraping Trigger**:
   - [main.py](file:///c:/kshitiz/D/CentralManagementPython/main.py) also calls `browser_sync.request_date(date)` to queue a background scrape for fresh data.
5. **Response**: Returns a JSON list of bookings.

### Scraping Flow
1. **Coordinator**: `BrowserSync.sync_availability` wakes up.
2. **Dispatch**: It sends the list of dates to `PlayoScraper.scrape()` and `HudleScraper.scrape()`.
3. **Execution**:
   - **Playo**: Navigates UI -> Scrapes DOM -> Returns Data list.
   - **Hudle**: Fetches API -> Parses JSON -> Returns Data list.
4. **Persistence**: The Scraper classes call `database.save_booked_slots_X()` to write to the DB transactionally.
